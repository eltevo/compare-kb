# User home directories

## Aims

1. Make user directories accessible accross docker hosts, from the hosts themselves as well as from unprivileged containers
2. Enforce per user quotas, even when files are not directly owned by the user

## Solution

1. Use XFS as file system. It supports project quotas, which can be applied on a per-directory basis instead of a per owner basis.
2. XFS supports ACLs by default to grant access to files which are not directly owned by the user.
3. Mount the XFS file system from a disk image, if no dedicated hardware disk is available.
4. Use an NFS server running inside a container to export the home file system to other network hosts.
5. Mount NFS export on every docker host to mount under containers as docker volumes.
6. Create a privileges container to proxy the NFS mount to other, unprivileged containers

## Components

* HOST: this is any server running the docker daemon. Can be many. Must have the NFS module loaded into the kernel.
* NFS: this is a docker container running the NFS server and enforcing the xfs quota.
* HOME: this is a privileged docker container proxying the NFS-mount to unprivileged container.

## System setup

Create disk image and format to xfs

	# cnt=`echo $HOME_DISKSIZEGB | awk '{print $1*1000}'`
	# dd if=/dev/zero of=$SRV/home.img bs=1M count=$cnt 
	# mkfs -t xfs $SRV/home.img
	
Create NFS container with disk image as a volume:

	# docker create --name NFS -v $SRV/home.img:/home.img --privileged NFS-IMAGE
	
Then, within the NFS container, mount the disk image under exports and set up the nfs export rule:
	
	# mkdir /exports/home
	# mount /home.img /exports/home -t xfs -o prjquota,loop=/dev/loop3	
	# echo "/exports/home *(rw,sync,no_subtree_check,fsid=0,no_root_squash)" > /etc/exports
	
Start or restart the nfs server. cpuguy83/docker-nfs-server gives some clues how to do it. Test if the nfs export is visible from the HOST:

	# showmount -e $NFSIP
	
Mount the nfs export to the host:

	# mkdir -p $SRV/home
	# mount $NFSIP:/exports/home $SRV/home
	
Check if it's mounted correctly:
	
	# mount | grep $NFSIP

To set quotas, create the files within the NFS container:

	# touch /etc/projects /etc/projid
	
Then create a "project" corresponding to the user and enforce quota:

	# echo $uid:/exports/home/$username >> /etc/projects
	# echo $username:$uid >> /etc/projid
	# xfs_quota -x -c "project -s $username" /exports/home
	# xfs_quota -x -c "limit -p bsoft=$HOME_QUOTA bhard=$HOME_QUOTA $username" /exports/home
	
To check disk usage, from within the NFS container, run

	# xfs_quota -x -c "report"
	
Now create a privileged container that will proxy the home nfs share/mount to unprivileged containers

	# docker create --name HOME -v $SRV/home:/home --privileged HOME-IMG
	
HOME-IMG is a minimal image that does nothing, just waits. Once it's up and running (waiting), other, non-privileged containers can reference its volume with the following command:

	# docker create ... --volumes-from HOME ...
	
## Tearing down the system

Tearing down a system is a bit tricky. Unless it's done in the right order, the loopback device used for mounting the xfs disk image may become busy indefinitely and cannot be reclaimed without rebooting the host machine. This is likely due to a kernel bug or race condition. The right steps are the following:

1. Stop all containers on all hosts referencing the HOME containers home volume with the --volumes-from switch.

2. Stop all HOME containers on all hosts.

3. Unmount the nfs shares on all hosts, preferably by network name or IP, instead of local mount dir:

	# umount NFSIP:/exports/home

4. Unexport the home directory from within the NFS container:

	# exportfs -u *:/exports/home
	
5. Unmount the disk image from the loopback device from within the NFS container:	
	
	# umount /exports/home
	
6. Stop the NFS server container.

If unmouting doesn't play nicely, try the -f -l switches.

## Granting access to files not owned by the user

Files owned by a particular user can only be created by the user or by a root process. If user files are generated by anything else will be owned by that process. ACLs allow granting access to the users regardless of file owners and default ACL entries get automatically added to filed created within directories.

To create a default ACL on a directory:

	# setfacl -m d:u:$username:rw file
	
To make sure files created within a directory are always owned by a particular group, turn the setgid flag on: (see: https://en.wikipedia.org/wiki/Setuid)

	# chmod -R g+ws dir